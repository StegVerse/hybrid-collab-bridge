name: StegVerse AI Entity (Bridge)

on:
  # Manual run for targeted actions
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Full repo name (e.g. StegVerse/StegCore)"
        required: true
      pr_number:
        description: "PR number to review (leave blank for repo-wide task)"
        required: false
      instructions:
        description: "High-level instructions for StegVerse-AI-001"
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  stegverse_ai:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_STEGVERSE_AI_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout bridge repo (for manifests/config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          # gh is preinstalled on many runners; ensure auth:
          echo "${GH_TOKEN}" | gh auth login --with-token

      - name: Prepare context
        id: prep
        run: |
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          INSTR="${{ github.event.inputs.instructions }}"

          if [ -z "$TARGET_REPO" ]; then
            echo "Target repo is required."
            exit 1
          fi

          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT

          if [ -n "$PR_NUMBER" ]; then
            # Grab diff for the specific PR
            DIFF_CONTENT="$(gh pr diff "$PR_NUMBER" --repo "$TARGET_REPO" | head -c 24000 || true)"
          else
            # Fallback: short repo snapshot (e.g. recent commits)
            DIFF_CONTENT="$(gh log -5 --repo "$TARGET_REPO" || echo 'No PR diff; context only.')"
          fi

          # Escape for JSON
          DIFF_ESCAPED=$(printf '%s' "$DIFF_CONTENT" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          INSTR_ESCAPED=$(printf '%s' "$INSTR" | python -c 'import json,sys; print(json.dumps(sys.stdin.read() or "Act as StegVerse-AI-001: review for security, clarity, and Guardian compliance."))')

          echo "diff_json=$DIFF_ESCAPED" >> $GITHUB_OUTPUT
          echo "instr_json=$INSTR_ESCAPED" >> $GITHUB_OUTPUT

      - name: Call OpenAI (StegVerse-AI-001)
        id: ai_call
        run: |
          TARGET_REPO="${{ steps.prep.outputs.target_repo }}"
          DIFF_JSON=${{ steps.prep.outputs.diff_json }}
          INSTR_JSON=${{ steps.prep.outputs.instr_json }}

          # System prompt: Guardian + StegVerse entity
          SYSTEM_PROMPT=$(cat << 'EOF'
You are "StegVerse-AI-001", an AI entity operating from the StegVerse Hybrid Collaboration Bridge.

Rules:
- Follow StegVerse Guardian principles: security, transparency, verifiability, non-abuse.
- Operate ONLY on GitHub content you are explicitly given.
- NEVER request or expose secrets, tokens, or credentials.
- Prefer minimal, well-justified, review-style responses.
- Always:
  1) Summarize what you see.
  2) List concrete findings (bugs, security issues, style, missing docs/tests).
  3) Provide precise suggestions or patch snippets in fenced code blocks where helpful.
- Treat Rigel and human maintainers as final authority.
EOF
)

          # Build JSON body for Responses API
          BODY=$(cat << EOF
{
  "model": "gpt-5-thinking",
  "input": [
    {
      "role": "system",
      "content": ${SYSTEM_PROMPT@Q}
    },
    {
      "role": "user",
      "content": "Target repository: ${TARGET_REPO}"
    },
    {
      "role": "user",
      "content": "Diff or context snippet (may be truncated):",
      "metadata": { "type": "context" }
    },
    {
      "role": "user",
      "content": $DIFF_JSON
    },
    {
      "role": "user",
      "content": "Instructions:",
      "metadata": { "type": "instructions" }
    },
    {
      "role": "user",
      "content": $INSTR_JSON
    }
  ],
  "max_output_tokens": 900,
  "temperature": 0.2
}
EOF
)

          RESPONSE=$(curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          echo "$RESPONSE" > response.json

          AI_COMMENT=$(cat response.json | jq -r '
            .output[0].content[0].text // 
            .choices[0].message.content // 
            "No response from model."
          ')

          echo "ai_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post response
        run: |
          TARGET_REPO="${{ steps.prep.outputs.target_repo }}"
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          AI_COMMENT="${{ steps.ai_call.outputs.ai_comment }}"

          echo "----- StegVerse-AI-001 output -----"
          echo "$AI_COMMENT"
          echo "-----------------------------------"

          if [ -n "$PR_NUMBER" ]; then
            gh pr comment "$PR_NUMBER" \
              --repo "$TARGET_REPO" \
              --body "$AI_COMMENT"
          else
            # Optionally: create an issue or log in the bridge repo instead
            gh issue create \
              --repo "${GITHUB_REPOSITORY}" \
              --title "StegVerse-AI-001 report for $TARGET_REPO" \
              --body "$AI_COMMENT" \
              || true
          fi
